# WARNING - Generated by {fusen} from dev/flat_dev_4_analysis.Rmd: do not edit by hand # nolint: line_length_linter.

#' Prepare Funding Opportunity Dataset
#'
#' Aggregates flows into donor-recipient-year observations and prepares features
#' for an opportunity prediction model. Features include:
#'  - donor funding cycle timing (mean decision month)
#'  - historical funding patterns (growth in recent years)
#'  - simple NLP signals from description/keywords (presence of crisis keywords)
#'  - sector funding trends (share to global clusters)
#'
#' This function returns a tidy dataframe suitable for model training.
#'
#' @param flows Dataframe `flows`.
#' @param lookback_years Integer number of past years to compute trends (default 3).
#' @param crisis_keywords Character vector of keywords to flag global events 
#' (default common terms).
#'
#' @return A tibble of donor, recipient, year, and features.
#' @importFrom dplyr select mutate group_by summarise left_join arrange pull rename if_else lag n
#' @importFrom tidyr unnest
#' @importFrom lubridate ymd year month ymd_hms
#' @importFrom stringr str_detect str_to_lower
#' @export
#' @examples
#' crisis_keywords = c("refugees", "refugee","displacement", "displaced",
#'                          "returnees","idps",
#'                         "protection", "conflict", "vulnerable")
#'
#' features <- analysis_prepare_opportunity_dataset( flows,
#'     lookback_years = 3,
#'     crisis_keywords = crisis_keywords)
#'
#' # Filter for non-NA growth, arrange by descending growth, and take the top 5.
#' label_data_top <- features |>
#'   dplyr::filter(!is.na(pct_growth)) |>
#'   dplyr::arrange(dplyr::desc(pct_growth)) |>
#'   dplyr::slice_head(n = 3) |>
#'   dplyr::mutate(donor_wrapped = stringr::str_wrap(paste0(donor, " --> ",
#'                                                   recipient),
#'                                            width = 45))
#'
#'
#' ggplot2::ggplot(features, ggplot2::aes(x = total_amount, y = pct_growth/100)) +
#'   ggplot2::geom_point(alpha = 0.5) +
#'   ggrepel::geom_text_repel(  data = label_data_top, 
#'                              ggplot2::aes(label = donor_wrapped), 
#'     size = 2.5, segment.color = 'grey50', 
#'     min.segment.length = 0, box.padding = 0.5 ) +
#'   ggplot2::scale_x_log10(
#'       labels = scales::label_number(scale_cut = scales::cut_short_scale())) +
#'   ggplot2::scale_y_continuous(labels = scales::label_percent()  ) +
#'   ggplot2::labs(
#'     title = "Funding Opportunity Analysis: Amount vs. Growth",
#'     subtitle = paste0(
#'             "Focusing on the following keywords within project description: ",
#'             paste(crisis_keywords, collapse = ", ")
#'         ),
#'     x = "Total Amount (log scale)",
#'     y = "Percentage Growth",
#'     caption= paste0(
#'       "Indicator interpretation: Points in the top-right quadrant indicate 
#'       high-value future opportunities.", "\n\n",
#'     "**Data Source**: OCHA Financial Tracking Service (FTS) API.")) +
#'   unhcrthemes::theme_unhcr(grid = TRUE, axis = TRUE, 
#'                            axis_title = TRUE, legend = TRUE)  
analysis_prepare_opportunity_dataset <- function(
    flows,
    lookback_years = 3,
    crisis_keywords = c("refugees", "refugee","displacement", "displaced",
                         "returnees","idps",
                        "protection", "conflict", "vulnerable")) {
  
  flows <- filter_flows_for_indicators(flows)
  # --- 1. Prepare Base Data (df) ---
  df <- flows |>
    tidyr::unnest(sourceObjects, names_sep = "_") |>
    dplyr::filter(sourceObjects_type == "Organization") |>
    dplyr::rename(donor = sourceObjects_name) |>
    tidyr::unnest(destinationObjects, names_sep = "_") |>
    dplyr::rename(recipient = destinationObjects_name, dest_type = destinationObjects_type) |>
    dplyr::filter(dest_type %in% c(
      "Location",
      "Organization",
      "GlobalCluster"
    )) |>
    dplyr::mutate(
      amountUSD = as.numeric(amountUSD),
      # Attempt to parse as datetime first
      decision_dt_hms = suppressWarnings(lubridate::ymd_hms(decisionDate)),
      # Attempt to parse as date second
      decision_dt_ymd = suppressWarnings(lubridate::ymd(decisionDate)),
      # Combine, prioritizing POSIXct (ymd_hms)
      # FIX: Use dplyr::if_else() or explicit logic to maintain date/time class
      decision_dt = dplyr::if_else(
        !is.na(decision_dt_hms),
        decision_dt_hms,
        as.POSIXct(decision_dt_ymd) # Convert Date to POSIXct for consistent column type
      )
    ) |>
    # Separate step to extract month/year from the correctly typed decision_dt
    dplyr::mutate(
      decision_month = as.integer(lubridate::month(decision_dt)),
      year = as.integer(budgetYear)
    ) |>
    dplyr::select(-decision_dt_hms, -decision_dt_ymd) # Clean up temp columns
  
  # --- 2. Per Donor-Recipient-Year Features (base) ---
  base <- df |>
    dplyr::group_by(donor, recipient, year) |>
    dplyr::summarise(
      total_amount = sum(amountUSD, na.rm = TRUE),
      n_flows = dplyr::n(),
      avg_decision_month = mean(decision_month, na.rm = TRUE),
      # Calculate flag for flows that have a crisis keyword in description
      crisis_flag = mean(
        stringr::str_detect(
          stringr::str_to_lower(description),
          paste(crisis_keywords, collapse = "|")
        ),
        na.rm = TRUE
      ),
      .groups = "drop"
    )
  
  # --- 3. Compute Recent Growth (growth) ---
  growth <- base |>
    dplyr::group_by(donor, recipient) |>
    dplyr::arrange(year) |>
    dplyr::mutate(
      lag_amount = dplyr::lag(total_amount, n = lookback_years, order_by = year),
      pct_growth = dplyr::if_else( # Use if_else for type safety
        !is.na(lag_amount) & lag_amount > 0,
        (total_amount - lag_amount) / lag_amount,
        NA_real_
      )
    ) |>
    dplyr::select(-lag_amount) |>
    dplyr::ungroup()
  
  # --- 4. Sector Trends: Max Cluster Share (cluster_share) ---
  # Only focus on flows to GlobalCluster/Cluster destinations
  cluster_share <- df |>
    dplyr::filter(dest_type %in% c("GlobalCluster", "Cluster")) |>
    # Calculate the total amount a donor gave to a specific cluster in a year
    dplyr::group_by(donor, recipient, year) |>
    dplyr::mutate(yearly_donor_funding = sum(amountUSD, na.rm = TRUE)) |>
    dplyr::ungroup() |>
    
    # Now group by the specific cluster destination
    dplyr::group_by(donor, year, recipient) |>
    dplyr::summarise(
      total_funding_to_recipient = sum(amountUSD, na.rm = TRUE),
      total_donor_funding_in_year = unique(yearly_donor_funding), # Total donor funding to *all* destinations this year
      .groups = "drop_last"
    ) |>
    # Compute the share of total annual donor funding that went to this recipient (cluster)
    dplyr::mutate(
      cluster_share = total_funding_to_recipient / total_donor_funding_in_year
    ) |>
    # Find the maximum share across all clusters for that donor-recipient-year
    dplyr::group_by(donor, recipient, year) |>
    dplyr::summarise(
      max_cluster_share = max(cluster_share, na.rm = TRUE),
      .groups = "drop"
    )
  
  # --- 5. Final Join and Return ---
  res <- growth |>
    dplyr::left_join(cluster_share, by = c("donor", "recipient", "year")) |>
    # Ensure max_cluster_share is 0 if no clusters were found for that DR-Y combination
    dplyr::mutate(max_cluster_share = dplyr::if_else(is.na(max_cluster_share), 0, max_cluster_share))
  
  return(res)
}
